
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Memoization and Decorator - Blog kỹ thuật máy tính</title>
	<meta name="author" content="kỹ thuật máy tính">

	
	<meta name="description" content="Memoization and Decorator What is memoization Trước hết chúng ta làm quen với khái niệm memoization. Ngôn ngữ ở đây là Python, bài toán là viết hàm &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Blog kỹ thuật máy tính" type="application/atom+xml">
	
	<link rel="canonical" href="http://ktmt.github.com/blog/2013/05/06/memoization-and-decorator/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		document.write("<img src='http://www.gravatar.com/avatar/" + MD5("") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
	</script>
</div>
<h1><a href="/">Blog kỹ thuật máy tính</a></h1>
<p class="subtitle">kỹ thuật máy tính</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Memoization and Decorator</h1>
	<div class="entry-content" itemprop="articleBody"><h2>What is memoization</h2>

<p>Trước hết chúng ta làm quen với khái niệm memoization. Ngôn ngữ ở đây là Python, bài toán là viết hàm tính giai thừa (n!)</p>

<p>Hàm giai thừa thông thường sẽ được viết đệ quy như sau:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def fac(n):
</span><span class='line'>    if n &lt; 2: return 1
</span><span class='line'>    return n * fac(n - 1)</span></code></pre></td></tr></table></div></figure>


<p>Áp dụng memoization dưới dạng dict, ta có thể viết hàm fac_m như sau:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>memo = {}
</span><span class='line'>def fac_m(n):
</span><span class='line'>    if n&lt;2: return 1
</span><span class='line'>    if n not in memo:
</span><span class='line'>        rel = n * facm(n-1)
</span><span class='line'>    return rel</span></code></pre></td></tr></table></div></figure>


<p>Như vậy memoization đơn giản chỉ là tìm cách nhớ những phần tử để giảm khối lượng tính toán</p>

<p>Memoization có thể implement dưới dạng function&#8230;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def memoize(fn, arg):
</span><span class='line'>    memo = {}
</span><span class='line'>    if arg not in memo:
</span><span class='line'>        memo[arg] = fn(arg)
</span><span class='line'>    return memo[arg]
</span><span class='line'>def fac_m_f(n):
</span><span class='line'>    return memoize(fac,n)</span></code></pre></td></tr></table></div></figure>


<p>&#8230;hoặc class</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Memoize:
</span><span class='line'>    def __init__(self, f):
</span><span class='line'>        self.f = f
</span><span class='line'>        self.memo = {}
</span><span class='line'>    def __call__(self, *args):
</span><span class='line'>        if not args in self.memo:
</span><span class='line'>            self.memo[args] = self.f(*args)
</span><span class='line'>        return self.memo[args]
</span><span class='line'>fac= Memoize(fac)</span></code></pre></td></tr></table></div></figure>


<p>Thêm 1 step nữa, thay vì &#8220;fac=Memoize(fac)&#8221; như ở trên, bạn có thể viết hàm mới theo kiểu decorator</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Memoize
</span><span class='line'>def fac_m_d(n):
</span><span class='line'>    if n&lt;2: return 1
</span><span class='line'>    return n * fac_m_d(n-1)</span></code></pre></td></tr></table></div></figure>


<p>Vậy decorator trong Python là gì và cách dùng ra sao ?</p>

<h2>Python decorator</h2>

<p>Trong số các design pattern, có 1 design pattern gọi là &#8220;decorator design pattern&#8221;. Decorator ở Python chỉ là 1 cách implement decorator design pattern. 2 khái niệm này không hoàn toàn giống nhau. Một điểm nữa cần nhớ là, memoization ở trên chỉ là 1 trong các ứng dụng của decorator, decorator còn có nhiều ứng dựng khác.</p>

<p>Decorator cho phép ta execute code trước hoặc sau function mà ko làm thay đổi code của function. Mọi function trong python đều là object, cho phép ta có thể assign funtion cho variable hoặc defince function trong chính 1 function khác. Dựa vào đó, decorator có thể là decorator class như trên, hoặc là decorator function</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def gotham(f):
</span><span class='line'>    def inside_gotham():
</span><span class='line'>        print "Gotham need Batman"
</span><span class='line'>        f()
</span><span class='line'>    return inside_gotham
</span><span class='line'>
</span><span class='line'>@gotham
</span><span class='line'>def batman():
</span><span class='line'>    print "Batman Here!"</span></code></pre></td></tr></table></div></figure>


<p>Cơ chế của decorator có thể hiểu đơn giản là, khi compiler đọc đến đoạn code đefine function với decorator, compiler sẽ compile function 1 cách bình thường và pass function object kết quả thẳng cho decorator(function hoặc class). Nếu decorator là class thì sẽ được gọi thông qua hàm <strong>call</strong> như ví dụ về memoization bên trên.</p>

<p>Với cách hiểu bên trên, có thể coi decorator là một &#8220;function&#8221; đặc biệt, lấy agrument là 1 function object và return kết quả cũng là 1 function object.</p>

<p>Ngoài memoization bên trên, bạn có thể dễ thấy rất nhiều ứng dụng của decorator trong các task liên quan đến wrap VD như</p>

<p>&#8230;timing</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def time_cal(func):
</span><span class='line'>    def wrapper(*arg):
</span><span class='line'>        t = time.time()
</span><span class='line'>        res = func(*arg)
</span><span class='line'>        print func.func_name, time.time()-t
</span><span class='line'>        return res
</span><span class='line'>    return wrapper
</span><span class='line'>
</span><span class='line'>@time_cal
</span><span class='line'>def fac(n):
</span><span class='line'>    if n &lt; 2: return 1
</span><span class='line'>    return n * fac(n - 1)</span></code></pre></td></tr></table></div></figure>


<p>hay trong web application, nếu bạn đã dùng Flaskr, bạn có thể thấy đoạn code sau</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@mod.route('/me/')
</span><span class='line'>@requires_login
</span><span class='line'>def home():
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Ở đây trang web của bạn ở sublink &#8220;&#8230;/me&#8221; sẽ được đảm bảo chỉ viewable với user đã login. Decorator &#8220;@requires_login&#8221; có thể viết ở 1 file độc lập và mọi hàm cần tính đảm bảo như trên chỉ cần thêm &#8220;@requires_login&#8221; đằng trước.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from functools import wraps
</span><span class='line'>...
</span><span class='line'>def requires_login(f):
</span><span class='line'>    @wraps(f)
</span><span class='line'>    def decorated_function(*args, **kwargs):
</span><span class='line'>        if g.user is None:
</span><span class='line'>            flash(u'You need to be signed in for this page.')
</span><span class='line'>            return redirect(url_for('users.login', next=request.path))
</span><span class='line'>        return f(*args, **kwargs)
</span><span class='line'>    return decorated_function</span></code></pre></td></tr></table></div></figure>


<h2>Kết luận</h2>

<ul>
<li>Memoization: pattern dùng để nhớ các tính toán nhằm làm giảm workload khi gặp các bài toán đệ quy</li>
<li>Decorator pattern: decorator design pattern</li>
<li>Python Decorator: Python tools để implement decorator pattern</li>
</ul>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2013

    kỹ thuật máy tính


</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ktmt';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ktmt.github.com/blog/2013/05/06/memoization-and-decorator/';
        var disqus_url = 'http://ktmt.github.com/blog/2013/05/06/memoization-and-decorator/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





		</div>
	</div>
</body>
</html>
