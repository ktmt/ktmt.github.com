<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: PHP | Blog kỹ thuật máy tính]]></title>
  <link href="http://toandk.github.com/blog/categories/php/atom.xml" rel="self"/>
  <link href="http://toandk.github.com/"/>
  <updated>2013-07-15T13:19:46+09:00</updated>
  <id>http://toandk.github.com/</id>
  <author>
    <name><![CDATA[kỹ thuật máy tính]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Inversion of Control and Dependency Injection]]></title>
    <link href="http://toandk.github.com/blog/2013/07/15/inversion-of-control-and-dependency-injection/"/>
    <updated>2013-07-15T02:02:00+09:00</updated>
    <id>http://toandk.github.com/blog/2013/07/15/inversion-of-control-and-dependency-injection</id>
    <content type="html"><![CDATA[<h2>Preface</h2>

<p>Trước khi đọc bài này, tôi có 1 vài recommend cho độc giả :)
1. Bạn nên đọc trước bài viết về [Builder Pattern trong Java] (http://ktmt.github.io/blog/2013/06/14/design-pattern-ap-dung-builder-pattern-trong-test-java/) cũng trong blog ktmt, sẽ có 1 cái nhìn tổng quát và hình dung dễ dàng hơn về ứng dụng của các pattern trong programming.
2. Có hàng tá bài viết về Inversion Of Control và Dependency Injection. Try to google it first.
3. Nếu không, nhớ google thêm sau khi đọc bài viết :D</p>

<h2>Dependency Injection</h2>

<p>Chúng ta sẽ bắt đầu với 1 ví dụ gần giống ví dụ trong bài viết về Builder Pattern ở trên. Xem đoạn code sau. Ngôn ngữ ở đây là PHP.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Book.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class Book ()</span>
</span><span class='line'><span class="x">{&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;public function __construct()</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&amp;gt;title = new Title;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;author = new Author;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;genre = new Genre;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;publishDate = new PublishDate;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;ISBN = new ISBN;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;}</span>
</span><span class='line'><span class="x">...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;$book = new Book;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Ở đây giả sử Title, Author, Genre, PublishDate hay ISBN đều là các class đã được định nghĩa trước. Như vậy class Book có 5 <strong>dependency</strong> là 5 class kể trên.</p>

<p>Về mặt technical, chẳng có gì là không ổn với 1 class như trên cả.
Tuy nhiên programmer có kinh nghiệm sẽ dễ dàng nhận thấy chúng ta đã hardcoded 5 dependency trên vào trong Book.
Nói cách khác nếu muốn Book chứa những dependency khác, chẳng có cách nào khác là sửa lại định nghĩa class.</p>

<p>Như vậy, để tránh những phiền phức nói trên và tạo độ linh hoạt khi sử dụng, class Book nên được viết lại như sau:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Book.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class Book ()</span>
</span><span class='line'><span class="x">{&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;public function __construct($title, $author, $genre, $publishdate, $isbn)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&amp;gt;title = $title;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;author = $author;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;genre = $genre;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;publishDate = $publishdate;</span>
</span><span class='line'><span class="x">    $this-&amp;gt;ISBN = $isbn;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;}</span>
</span><span class='line'><span class="x">...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;$book = new Book (new Title, new Author, new Genre, new PublishDate, new ISBN)&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Bạn có thể thấy, ý tưởng của Dependency Injection(DI) thực ra rất đơn giản, chỉ là bạn vẫn thường sử dụng và không để ý.
Dependency có thể được inject theo nhiều kiểu, ví dụ bên trên là constructor injection.
Chúng ta còn có setter injection như sau:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Book.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class Book ()</span>
</span><span class='line'><span class="x">{&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;public function __construct()</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">public function setTitle($title)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&amp;gt;title = $title;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;...  Here we have 4 more methods : setAuthor ,setGenre, setPublishDate, setISBN</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;$book = new Book;</span>
</span><span class='line'><span class="x">$book-&gt;setTitle(new Title);</span>
</span><span class='line'><span class="x">$book-&gt;setAuthor(new Author);</span>
</span><span class='line'><span class="x">$book-&gt;setGenre(new Genre);</span>
</span><span class='line'><span class="x">$book-&gt;setPublishDate(new PublishDate);</span>
</span><span class='line'><span class="x">$book-&gt;setISBN(new ISBN);&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Và vấn đề mới lại nảy sinh! Có quá nhiều setter và điều đó biến Book thành 1 class phức tạp khi sử dụng.
Việc viết lại tất cả các setter khi khởi tạo 1 Book thật là painful !</p>

<p>Để giải quyết vấn đề kể trên, chúng ta sẽ đến với design pattern tiếp theo: Inversion of Control(IoC)</p>

<h2>Inversion of Control</h2>

<blockquote><p>In software engineering, inversion of control (IoC) is a programming technique, expressed here in terms of object-oriented programming, in which object coupling is bound at run time by an assembler object and is typically not known at compile time using static analysis.</p></blockquote>

<p>Giải thích lý thuyết về IoC có lẽ sẽ tốn nhiều công sức,
như recommend trên đầu bài, bạn có thể google 1 chút về IoC.
Ở đây tôi sẽ đưa ra luôn 1 implement để sử dụng với class Book kể trên.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>IoC.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class IoC {</span>
</span><span class='line'><span class="x">   protected static $registry = array();&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;   // Register</span>
</span><span class='line'><span class="x">   public static function register($name, Closure $resolve)</span>
</span><span class='line'><span class="x">   {&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;  static::$registry[$name] = $resolve;</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;   }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;   // Resolve</span>
</span><span class='line'><span class="x">   public static function resolve($name)</span>
</span><span class='line'><span class="x">   {&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;  if ( static::registered($name) )</span>
</span><span class='line'><span class="x">  {</span>
</span><span class='line'><span class="x">     $name = static::$registry[$name];</span>
</span><span class='line'><span class="x">     return $name();</span>
</span><span class='line'><span class="x">  }</span>
</span><span class='line'>
</span><span class='line'><span class="x">  throw new Exception(&#39;Nothing registered with that name, fool.&#39;);</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;   }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;   // Check resigtered or not</span>
</span><span class='line'><span class="x">   public static function registered($name)</span>
</span><span class='line'><span class="x">   {&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;  return array_key_exists($name, static::$registry);</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;   }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>WTH! Cái khỉ gì trông lằng nhằng quá phải không :D</p>

<p>Đừng lo lắng, để hiểu đoạn code trên, trước hết, hãy để ý rằng ở đây chúng ta có rất nhiều các static function,
nghĩa là các function có thể gọi trục tiếp trên class chứ không phải trên instance thông qua cách gọi "Class::StaticMethod()"
Ngoài ra Closure là 1 anonymous function. Bạn sẽ hiểu ngay khi xem cách dùng dưới đây</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Book.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">IoC:register(&#39;book&#39;, function(){&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;$book = new Book;</span>
</span><span class='line'><span class="x">$book-&amp;gt;setTitle(new Title);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setAuthor(new Author);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setGenre(new Genre);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setPublishDate(new PublishDate);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setISBN(new ISBN);</span>
</span><span class='line'>
</span><span class='line'><span class="x">return $book;</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;});</span>
</span><span class='line'><span class="x">...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;$book = IoC::resolve(&#39;book&#39;);&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Woo! Bây giở mỗi khi muốn tạo 1 instance của Book với đầy đủ các dependency, chỉ cần IoC:resolve('book').
Cùng với đó, các dependency có thể inject thông qua register.
Đến khi unit test, bạn có thể dùng IoC::register để mocking các dependency và test Book mà không khởi tạo Title,Author,....</p>

<h2>Singleton pattern with IoC</h2>

<p>Bạn thử tưởng tượng, nếu như phần register 'book' bên trên chiếm nhiều tài nguyên, có thể bạn sẽ không muốn mỗi lần resolve lại khởi tạo 1 instance mới.
Nói cách khác, bạn chỉ muốn chỉ có 1 Book với đầy đủ Title, Author, ... được khởi tạo 1 lần, và lần sau muốn sử dụng thì gọi lại chính instance đã được tạo.</p>

<p>Đây là đất diễn của Singleton design pattern :)
Tôi sẽ viết thêm 1 static function cho IoC như sau:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>IoC.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class IoC {</span>
</span><span class='line'><span class="x">  protected static $registry = array();</span>
</span><span class='line'><span class="x">  protected static $shared = array();&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  // Singleton</span>
</span><span class='line'><span class="x">  public static function singleton($name, $resolve)</span>
</span><span class='line'><span class="x">  {&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;static::$shared[$name] = $resolve;</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  // Resolve, consider register or singleton here</span>
</span><span class='line'><span class="x">  public static function resolve($name)</span>
</span><span class='line'><span class="x">  {&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;if ( static::registered($name) )</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">  $name = static::$registry[$name];</span>
</span><span class='line'><span class="x">  return $name();</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">if ( static::singletoned($name) )</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">  $instance = static::$singleton[$name];</span>
</span><span class='line'><span class="x">  return $instance;</span>
</span><span class='line'><span class="x">} </span>
</span><span class='line'>
</span><span class='line'><span class="x">throw new Exception(&#39;Nothing registered with that name, fool.&#39;);</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  // Check singleton object or not</span>
</span><span class='line'><span class="x">  public static function singletoned($name)</span>
</span><span class='line'><span class="x">  {&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;return array_key_exists($name, static::$shared);</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Và bây giờ
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Book.php</span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">IoC:singleton(&#39;book&#39;, function(){&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;$book = new Book;</span>
</span><span class='line'><span class="x">$book-&amp;gt;setTitle(new Title);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setAuthor(new Author);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setGenre(new Genre);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setPublishDate(new PublishDate);</span>
</span><span class='line'><span class="x">$book-&amp;gt;setISBN(new ISBN);</span>
</span><span class='line'>
</span><span class='line'><span class="x">return $book;</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;});</span>
</span><span class='line'><span class="x">...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;$book1 = IoC::resolve(&#39;book&#39;);</span>
</span><span class='line'><span class="x">$book2 = IoC::resolve(&#39;book&#39;); // exactly same instance with $book1&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Have fun with IoC :)</p>

<h2>Summary</h2>

<ul>
<li>Dependency Injection: Đưa các dependency vào class thông qua constructor hoặc setter, không khỏi tạo trực tiếp bên trong class</li>
<li>Inversion of Control: bind object vào thời điểm run time, không phải vào thời điểm complile time.</li>
<li>Singleton: Design pattern, cho phép trong 1 hệ thống chỉ có 1 instance duy nhất của class được tồn tại.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[99-bottles-of-beer]]></title>
    <link href="http://toandk.github.com/blog/2013/06/02/99-bottles-of-beer/"/>
    <updated>2013-06-02T19:47:00+09:00</updated>
    <id>http://toandk.github.com/blog/2013/06/02/99-bottles-of-beer</id>
    <content type="html"><![CDATA[<h2>The song, and the home page</h2>

<p>Đầu tiên có thể độc giả sẽ tự hỏi ý nghĩa của tiêu đề bài viết là gì ? Vậy trước hết mời bạn ghé qua <a href="http://99-bottles-of-beer.net">home page</a> và enjoy the <a href="http://www.youtube.com/watch?v=qVjCag8XoHQ">song</a></p>

<p>99-bottles-of-beer cũng từng là đề bài của code golf và phpgolf. Mission của chúng ta là code 1 đoạn PHP snippet print <a href="http://99-bottles-of-beer.net/lyrics.html">lyric</a> của bài hát mà dung lượng đoạn code là nhỏ nhất.
Logic thật đơn giản phải không :D</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>lyric</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>99 bottles of beer on the wall, 99 bottles of beer.
</span><span class='line'>Take one down and pass it around, 98 bottles of beer on the wall.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>98 bottles of beer on the wall, 98 bottles of beer.
</span><span class='line'>Take one down and pass it around, 97 bottles of beer on the wall.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>97 bottles of beer on the wall, 97 bottles of beer.
</span><span class='line'>Take one down and pass it around, 96 bottles of beer on the wall.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>...&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>1 bottle of beer on the wall, 1 bottle of beer.
</span><span class='line'>Go to the store and buy some more, 99 bottles of beer on the wall.</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Với mục tiêu dùng ít code nhất có thể, tôi sẽ không dùng cấu trúc rẽ nhánh if-else, thay vào đó là ternary operator của PHP
( có nghĩa là bạn có thể viết "(condition)?true-action:false-action" thay vì "if (condition) {true-action} else {false-action}"  )</p>

<p>Đoạn code đầu tiên tôi nghĩ ra trong đầu như sau:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>sol1.php </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&amp;lt;?php</span>
</span><span class='line'><span class="x">  $a=&quot;beer on the wall&quot;;</span>
</span><span class='line'><span class="x">  for($i=99;$i&gt;=1;$i--){&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;pre&gt;&lt;code&gt;$x=($i==1)?&quot;bottle&quot;:&quot;bottles&quot;;</span>
</span><span class='line'><span class="x">$b=&quot;&amp;lt;p&amp;gt;$i $x of $a, $i $x of beer.&amp;lt;br&amp;gt;&quot;;</span>
</span><span class='line'><span class="x">$b.=($i==1)?&quot;Go to the store and buy some more, 99 bottles of $a.&quot;:&quot;Take one down and pass it around, &quot;.($i-1).&quot; $x of $a.&amp;lt;/p&amp;gt;&quot;;</span>
</span><span class='line'><span class="x">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;  print $b;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">?&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Optimize</h2>

<p>Bạn thử ls -l sẽ thấy đoạn code trên có dung lượng 288 bytes!</p>

<p>Để rút ngắn đoạn code trên, đầu tiên tôi nhớ lại những kiến thức cơ bản về PHP: dấu space hoàn toàn không cần thiết, và ký tự "?>" ở cuối cũng có thể bỏ đi
PHP long tag ở đầu có thể thay = PHP short tag</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>sol2.php </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&amp;lt;?</span>
</span><span class='line'><span class="x">$a=&quot;beer on the wall&quot;;</span>
</span><span class='line'><span class="x">for($i=99;$i&gt;=1;$i--){</span>
</span><span class='line'><span class="x">$x=($i==1)?&quot;bottle&quot;:&quot;bottles&quot;;</span>
</span><span class='line'><span class="x">$b=&quot;&lt;p&gt;$i $x of $a, $i $x of beer.&lt;br&gt;&quot;;</span>
</span><span class='line'><span class="x">$b.=($i==1)?&quot;Go to the store and buy some more, 99 bottles of $a.&quot;:&quot;Take one down and pass it around, &quot;.($i-1).&quot; $x of $a.&lt;/p&gt;&quot;;</span>
</span><span class='line'><span class="x">print $b;</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>263 bytes!</p>

<p>Làm thế nào để rút ngắn hơn nữa ? Nếu để ý vào những chi tiết nhỏ hơn, bạn sẽ thấy:</p>

<ul>
<li>trong điều kiện vòng lặp, thay "$i>=1" bằng "$i>0"</li>
<li>"($i==1)?" là quá dài. Ta có thể bỏ đi 2 dấu ngoặc "$i==1?"</li>
<li>print có thể thay bằng echo. ( Thực tế trong PHP bạn còn có thể thay rtrim -> chop, explode -> split, implode -> join, preg_split -> split (trong 1 vài trường hợp) và preg_replace -> preg_filter trong hầu hết các TH  )</li>
<li>"$x=($i==1)?"bottle":"bottles";" có thể được viết lại : "$x='bottle';$i==1?:$x.='s';"</li>
<li>Mỗi lần sử dụng biến $a ta đều có "of" ở đăng trước. Vậy có thể đơn giản cho word "of" vào trong biến a</li>
<li>"99 bottles of $a" có thể rewrite tiếp lại thành "99{$x}s of $a"</li>
<li>Chúng ta có thể xoá "$i--" trong vòng lặp for, vì thế thêm -- vào trước "$i==1" ở dòng gần cuối thành "$i--==1" và vì thế bỏ luôn đoạn ($i-1) ở sau đó</li>
</ul>


<p>Như vậy solution tiếp theo của chúng ta sẽ là
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>sol2.php </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&amp;lt;?</span>
</span><span class='line'><span class="x">$a=&quot; of beer on the wall&quot;;</span>
</span><span class='line'><span class="x">for($i=99;$i&gt;=1;){</span>
</span><span class='line'><span class="x">$x=&#39;bottle&#39;;$i==1?:$x.=&#39;s&#39;;</span>
</span><span class='line'><span class="x">$b=&quot;&lt;p&gt;$i $x$a, $i $x of beer.&lt;br&gt;&quot;;</span>
</span><span class='line'><span class="x">$b.=$i--==1?&quot;Go to the store and buy some more, 99 {$x}s$a.&quot;:&quot;Take one down and pass it around, &quot;.$i.&quot; $x$a.&lt;/p&gt;&quot;;</span>
</span><span class='line'><span class="x">echo $b;</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>241 bytes!</p>

<h2>The trick</h2>

<p>Bạn có nghĩ đã hết cách để rút gọn đoạn code ?</p>

<p>Bạn có quên điều gì không ? Bỏ đi tất cả các ký tự line-feed (line break), cho code thành 1 dòng, chúng ra sẽ có kết quả tốt hơn.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>sol4.php </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&amp;lt;?$a=&quot; of beer on the wall&quot;;for($i=99;$i&gt;0;){$x=&#39;bottle&#39;;$i&lt;sup&gt;1?$x.=&#39;s&#39;:0;$b=&quot;&lt;p&gt;$i&lt;/sup&gt; $x$a, $i $x of beer.&lt;br&gt;&quot;;$b.=$</span>
</span><span class='line'><span class="x">i--==1?&quot;Go to the store and buy some more, 99 {$x}s$a.&quot;:&quot;Take one down and pass it around, &quot;.$i.&quot; $x$a.&lt;/p&gt;&quot;;echo</span>
</span><span class='line'><span class="x"> $b;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>233 bytes!</p>

<p>Bạn có tin có 1 đoạn code sẽ cho kết quả tương tự với ... 30 bytes ???</p>

<p>!!</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>trick.php </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&amp;lt;?include(&#39;http://bit.ly/xxxx&#39;); ?&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>PHP là 1 ngôn ngữ web! Với allow_url_fopen và allow_url_include turn on có thể dễ dàng load 1 link kết quả có sẵn đi kèm 1 dịch vụ như bitly !</p>

<p>Stay hungry, stay foolish :D</p>

<h2>Tham khảo</h2>

<ol>
<li><a href="http://www.phpgolf.org/tips">phpgolf tips and tricks</a></li>
<li><a href="http://stackoverflow.com/questions/3801097/solve-this-php-puzzle-in-as-few-bytes-as-possible">Question on StackOverFlow</a></li>
</ol>

]]></content>
  </entry>
  
</feed>
